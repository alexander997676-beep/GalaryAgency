<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#030303">
    <meta name="description" content="Gallery Agency - The Visual Alchemy Engine">
    <title>GALLERY AGENCY | Nebula Edition</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Manrope:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- üåå CORE VARIABLES --- */
        :root {
            --bg: #030303;
            --surface: #0f0f0f;
            --surface-glass: rgba(15, 15, 15, 0.75);
            --border: rgba(255, 255, 255, 0.08);
            --border-highlight: rgba(255, 255, 255, 0.2);
            
            --primary: #f0f0f0;
            --secondary: #888;
            --accent-gold: #D4AF37;
            --accent-glow: rgba(212, 175, 55, 0.3);
            
            --font-display: 'Italiana', serif;
            --font-ui: 'Manrope', sans-serif;
            
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* --- RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-gold); }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: var(--font-ui);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- üå† NEBULA BACKGROUND --- */
        .nebula-bg {
            position: fixed; inset: 0; z-index: -1;
            background: var(--bg);
            overflow: hidden;
        }
        .nebula-orb {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.4;
            animation: drift 20s infinite alternate ease-in-out;
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: radial-gradient(circle, #1a1a2e 0%, transparent 70%); animation-duration: 25s; }
        .orb-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, #251e1e 0%, transparent 70%); animation-duration: 30s; }
        .orb-3 { top: 40%; left: 40%; width: 30vw; height: 30vw; background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%); animation-duration: 15s; }

        @keyframes drift { from { transform: translate(0, 0); } to { transform: translate(30px, 30px); } }

        /* --- üíé GLASS HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;
            background: var(--surface-glass); 
            backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-bottom: 1px solid var(--border); transition: transform 0.4s var(--ease-out);
        }
        header.hide { transform: translateY(-100%); }

        .logo { 
            font-family: var(--font-display); font-size: 24px; letter-spacing: 2px; 
            color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .logo span { color: var(--accent-gold); font-size: 14px; letter-spacing: 4px; padding-top: 4px; }

        .nav { display: flex; gap: 30px; }
        .nav-link {
            background: none; border: none; color: var(--secondary);
            font-family: var(--font-ui); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; position: relative; transition: 0.3s;
        }
        .nav-link::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 0; height: 2px; background: var(--accent-gold); transition: 0.3s var(--ease-out);
        }
        .nav-link.active, .nav-link:hover { color: var(--primary); }
        .nav-link.active::after { width: 100%; }

        /* --- ‚ö° HERO SECTION --- */
        .hero {
            padding: 160px 20px 60px; text-align: center; position: relative;
        }
        .hero-title {
            font-family: var(--font-display); font-size: clamp(3.5rem, 12vw, 7rem);
            line-height: 0.9; margin-bottom: 20px;
            background: linear-gradient(to bottom, #fff 20%, #666 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: fadeUp 1s var(--ease-out);
        }
        .hero-subtitle {
            color: var(--accent-gold); font-size: 11px; letter-spacing: 4px; text-transform: uppercase;
            margin-bottom: 50px; opacity: 0; animation: fadeUp 1s var(--ease-out) 0.2s forwards;
            display: inline-block; padding: 6px 16px; border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 50px;
        }

        /* --- üîç SEARCH & FILTERS --- */
        .search-container {
            max-width: 600px; margin: 0 auto 60px; position: relative;
            opacity: 0; animation: fadeUp 1s var(--ease-out) 0.4s forwards;
        }
        .search-box {
            width: 100%; display: flex; align-items: center;
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px 20px; transition: 0.3s;
        }
        .search-box:focus-within { border-color: var(--accent-gold); background: rgba(0,0,0,0.3); box-shadow: 0 0 30px var(--accent-glow); }
        .search-input {
            width: 100%; background: none; border: none; color: white;
            font-family: var(--font-ui); font-size: 16px; margin-left: 10px;
        }
        .search-tags {
            display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 20px;
        }
        .tag {
            padding: 8px 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 20px; font-size: 11px; color: var(--secondary); cursor: pointer; transition: 0.3s;
        }
        .tag:hover, .tag.active {
            border-color: var(--accent-gold); color: var(--bg); background: var(--accent-gold);
            transform: translateY(-2px);
        }

        /* --- üñºÔ∏è MASONRY GRID --- */
        .grid-wrapper { padding: 0 40px 100px; }
        .masonry {
            column-count: 5; column-gap: 24px;
        }
        @media(max-width:1600px){ .masonry{column-count:4;} }
        @media(max-width:1200px){ .masonry{column-count:3;} }
        @media(max-width:800px){ .masonry{column-count:2; column-gap: 15px;} padding: 0 15px 100px; }

        .card {
            break-inside: avoid; margin-bottom: 24px; border-radius: 12px;
            background: #111; overflow: hidden; position: relative;
            cursor: zoom-in; opacity: 0; transform: translateY(30px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        .card.visible { opacity: 1; transform: translateY(0); }
        
        .card-inner { position: relative; overflow: hidden; }
        .card img { width: 100%; display: block; transition: transform 0.7s var(--ease-out); will-change: transform; }
        
        /* Hover Effects */
        .card:hover img { transform: scale(1.08); }
        .card::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .card:hover::after { opacity: 1; }
        
        .card-actions {
            position: absolute; bottom: 15px; right: 15px; z-index: 2;
            display: flex; gap: 10px; opacity: 0; transform: translateY(10px); transition: 0.3s 0.1s;
        }
        .card:hover .card-actions { opacity: 1; transform: translateY(0); }
        
        .mini-btn {
            width: 35px; height: 35px; border-radius: 50%;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            color: white; border: none; cursor: pointer; transition: 0.2s;
        }
        .mini-btn:hover { background: white; color: black; }

        /* --- üé® STUDIO MODAL --- */
        .modal {
            position: fixed; inset: 0; z-index: 5000;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(15px);
            opacity: 0; pointer-events: none; transition: 0.4s;
            display: flex; justify-content: center; align-items: center;
        }
        .modal.active { opacity: 1; pointer-events: all; }

        .studio-container {
            width: 95vw; height: 90vh; background: #080808;
            border: 1px solid var(--border); border-radius: 20px;
            display: flex; overflow: hidden; box-shadow: 0 50px 100px rgba(0,0,0,0.8);
            /* Smooth transition for layout changes */
            transition: all 0.5s var(--ease-out);
        }

        /* Preview Area */
        .studio-canvas {
            flex: 1; position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            transition: all 0.5s var(--ease-out);
        }
        .img-wrapper {
            max-width: 90%; max-height: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: 0.3s ease;
        }
        #preview-img { 
            display: block; max-width: 100%; max-height: 100%; object-fit: contain;
            cursor: zoom-in; /* Indicates it's clickable */
        }

        /* Controls Sidebar */
        .studio-panel {
            width: 360px; background: #0c0c0c; border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            transition: all 0.5s var(--ease-out);
            opacity: 1;
        }
        .panel-header {
            padding: 25px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-header h2 { font-family: var(--font-display); font-size: 20px; }
        .close-btn { color: var(--secondary); cursor: pointer; font-size: 20px; transition: 0.3s; }
        .close-btn:hover { color: white; transform: rotate(90deg); }

        .panel-content { flex: 1; overflow-y: auto; padding: 25px; }

        /* Filter Presets */
        .section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent-gold); margin-bottom: 15px; }
        
        .preset-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 30px; }
        .preset-btn {
            flex: 0 0 70px; height: 70px; border-radius: 8px; border: 1px solid var(--border);
            background: #151515; color: var(--secondary); font-size: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            cursor: pointer; transition: 0.3s;
        }
        .preset-btn:hover, .preset-btn.active { border-color: var(--accent-gold); color: white; background: #222; }
        .preset-btn i { font-size: 16px; }

        /* Sliders */
        .control-group { margin-bottom: 25px; }
        .control-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #ccc; }
        
        input[type=range] {
            width: 100%; height: 4px; background: #333; border-radius: 2px;
            appearance: none; outline: none; cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 14px; height: 14px; background: var(--accent-gold);
            border-radius: 50%; transition: 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); }

        /* Footer Actions */
        .panel-footer {
            padding: 25px; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 12px;
        }
        .btn {
            width: 100%; padding: 14px; border-radius: 8px; border: none;
            font-family: var(--font-ui); font-weight: 700; font-size: 12px; letter-spacing: 1px;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-transform: uppercase;
        }
        .btn-primary { background: var(--accent-gold); color: #000; }
        .btn-primary:hover { background: #fff; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-secondary { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: white; }

        /* --- üì± RESPONSIVE MODAL --- */
        @media (max-width: 900px) {
            .studio-container { flex-direction: column; width: 100%; height: 100%; border-radius: 0; border: none; }
            .studio-canvas { height: 50%; }
            .studio-panel { width: 100%; height: 50%; border-left: none; border-top: 1px solid var(--border); }
            .preset-scroll { margin-bottom: 15px; }
        }

        /* --- üçû TOAST & LOADERS --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px);
            background: rgba(255,255,255,0.95); color: #000; padding: 12px 24px;
            border-radius: 50px; font-weight: 600; font-size: 13px; opacity: 0; pointer-events: none;
            transition: 0.4s var(--ease-elastic); z-index: 6000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }
        
        .loader {
            width: 50px; height: 50px; border: 2px solid var(--border);
            border-top-color: var(--accent-gold); border-radius: 50%;
            animation: spin 1s infinite linear; margin: 20px auto; opacity: 0; transition: 0.3s;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SPLASH SCREEN STYLES --- */
        #splash {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.8s ease;
        }
        .splash-logo {
            font-family: var(--font-display); 
            font-size: 50px; 
            color: transparent;
            -webkit-text-stroke: 1px rgba(255,255,255,0.5);
            animation: fillLogo 2s forwards ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }
        .splash-logo span {
            font-family: var(--font-ui); font-size: 14px; letter-spacing: 12px; 
            margin-left: 12px; margin-top: 10px; color: var(--accent-gold);
            -webkit-text-stroke: 0; -webkit-text-fill-color: var(--accent-gold) !important;
            font-weight: 500; opacity: 0; animation: fadeUp 1s ease-out 0.5s forwards;
        }
        @keyframes fillLogo { 0% { -webkit-text-fill-color: transparent; } 100% { -webkit-text-fill-color: white; } }

        /* --- üî≠ MAXIMIZE / FULL VIEW STYLES (New Feature) --- */
        .studio-container.maximize .studio-panel {
            width: 0; padding: 0; opacity: 0; pointer-events: none; border: none;
            overflow: hidden;
        }
        .studio-container.maximize .studio-canvas {
            flex: 100%; /* Takes full width */
            background: #000;
        }
        .studio-container.maximize .img-wrapper {
            max-width: 98%; max-height: 98%;
            box-shadow: none; /* Cleaner look when maximized */
        }
        .studio-container.maximize #preview-img {
            cursor: zoom-out; /* Change cursor to indicate you can click to close */
        }

        /* Mobile Maximize Fix */
        @media (max-width: 900px) {
            .studio-container.maximize .studio-panel {
                height: 0; width: 100%; border-top: none;
            }
            .studio-container.maximize .studio-canvas {
                height: 100%;
            }
        }

    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash">
        <div class="splash-logo">
            GALLERY
            <span>AGENCY</span>
        </div>
    </div>

    <!-- Background -->
    <div class="nebula-bg">
        <div class="nebula-orb orb-1"></div>
        <div class="nebula-orb orb-2"></div>
        <div class="nebula-orb orb-3"></div>
    </div>

    <!-- Header -->
    <header id="header">
        <div class="logo" onclick="resetApp()">GALLERY <span>AGENCY</span></div>
        <div class="nav">
            <button class="nav-link active" onclick="switchView('grid')" id="nav-grid">Discover</button>
            <button class="nav-link" onclick="switchView('fav')" id="nav-fav">Favorites</button>
        </div>
    </header>

    <!-- Notification -->
    <div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span>Action Completed</span></div>

    <!-- Hero -->
    <section class="hero" id="hero">
        <h1 class="hero-title">Visual Alchemy</h1>
        <div class="hero-subtitle">MADE BY FAIZAN AHMED</div>

        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search" style="color:var(--secondary)"></i>
                <input type="text" class="search-input" id="search" placeholder="Search the infinite..." autocomplete="off">
            </div>
            <div class="search-tags">
                <span class="tag active" onclick="triggerSearch('Aesthetic 4k')">Mixed</span>
                <span class="tag" onclick="triggerSearch('Dark Nature')">Nature</span>
                <span class="tag" onclick="triggerSearch('Cyberpunk City')">Cyber</span>
                <span class="tag" onclick="triggerSearch('Minimalist Architecture')">Arch</span>
                <span class="tag" onclick="triggerSearch('Abstract 8k')">Abstract</span>
            </div>
        </div>
    </section>

    <!-- Content Grid -->
    <div class="grid-wrapper">
        <div class="masonry" id="grid"></div>
        <div class="loader" id="loader"></div>
    </div>

    <!-- Studio Modal -->
    <div class="modal" id="studio">
        <div class="studio-container">
            <div class="studio-canvas">
                <div class="img-wrapper">
                    <!-- Added onclick toggleMaximize here -->
                    <img id="preview-img" crossorigin="anonymous" src="" onclick="toggleMaximize()">
                </div>
            </div>
            <div class="studio-panel">
                <div class="panel-header">
                    <h2>STUDIO</h2>
                    <i class="fas fa-times close-btn" onclick="closeStudio()"></i>
                </div>
                
                <div class="panel-content">
                    <div class="section-title">Presets</div>
                    <div class="preset-scroll">
                        <div class="preset-btn active" onclick="applyPreset('normal')"><i class="fas fa-ban"></i>Normal</div>
                        <div class="preset-btn" onclick="applyPreset('noir')"><i class="fas fa-moon"></i>Noir</div>
                        <div class="preset-btn" onclick="applyPreset('vintage')"><i class="fas fa-coffee"></i>Vintage</div>
                        <div class="preset-btn" onclick="applyPreset('vivid')"><i class="fas fa-sun"></i>Vivid</div>
                        <div class="preset-btn" onclick="applyPreset('cyber')"><i class="fas fa-bolt"></i>Cyber</div>
                    </div>

                    <div class="section-title">Adjustments</div>
                    <div class="control-group">
                        <div class="control-header"><span>Brightness</span><span id="val-b">100%</span></div>
                        <input type="range" min="50" max="150" value="100" data-filter="brightness">
                    </div>
                    <div class="control-group">
                        <div class="control-header"><span>Contrast</span><span id="val-c">100%</span></div>
                        <input type="range" min="50" max="150" value="100" data-filter="contrast">
                    </div>
                    <div class="control-group">
                        <div class="control-header"><span>Saturation</span><span id="val-s">100%</span></div>
                        <input type="range" min="0" max="200" value="100" data-filter="saturate">
                    </div>
                    <div class="control-group">
                        <div class="control-header"><span>Blur</span><span id="val-l">0px</span></div>
                        <input type="range" min="0" max="10" value="0" step="0.5" data-filter="blur">
                    </div>
                </div>

                <div class="panel-footer">
                    <button class="btn btn-primary" id="dl-btn" onclick="downloadImage()">
                        <i class="fas fa-download"></i> Save Masterpiece
                    </button>
                    <button class="btn btn-secondary" id="fav-btn" onclick="toggleFavorite()">
                        <i class="far fa-heart"></i> Add to Favorites
                    </button>
                    <button class="btn btn-secondary" onclick="shareImage()">
                        <i class="fas fa-share-alt"></i> Share Photo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- üß† CORE LOGIC ---
        const state = {
            query: 'Aesthetic Wallpapers 4k',
            page: 1,
            loading: false,
            currentUrl: null,
            favorites: JSON.parse(localStorage.getItem('gallery_favs')) || [],
            view: 'grid',
            filters: { brightness: 100, contrast: 100, saturate: 100, blur: 0, grayscale: 0, sepia: 0 }
        };

        const DOM = {
            grid: document.getElementById('grid'),
            loader: document.getElementById('loader'),
            studio: document.getElementById('studio'),
            preview: document.getElementById('preview-img'),
            header: document.getElementById('header'),
            search: document.getElementById('search')
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = 0;
                setTimeout(() => document.getElementById('splash').remove(), 800);
            }, 1500);
            fetchContent();
            setupEvents();
        });

        // --- API & RENDER ---
        async function fetchContent(append = false) {
            if (state.loading) return;
            state.loading = true;
            DOM.loader.style.opacity = 1;

            if (!append) DOM.grid.innerHTML = '';
            
            // Randomize page for variety
            const apiPage = Math.floor(Math.random() * 20) + 1;
            const url = `https://api.xyro.site/search/pinterest?q=${encodeURIComponent(state.query)}%20${apiPage}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                let images = extractImages(data);
                
                if(images.length === 0 && !append) {
                    DOM.grid.innerHTML = `<div style="text-align:center; grid-column:span 5; padding:40px; color:#666">No signals found in the void.</div>`;
                }

                images.forEach((imgUrl, index) => {
                    const card = createCard(imgUrl);
                    DOM.grid.appendChild(card);
                    // Staggered animation
                    setTimeout(() => card.classList.add('visible'), 50 + (index * 50));
                });

            } catch (err) {
                console.error("Transmission Error:", err);
                if(!append) DOM.grid.innerHTML = `<div style="text-align:center; grid-column:span 5; padding:40px; color:#666">Connection Lost.</div>`;
            }

            state.loading = false;
            DOM.loader.style.opacity = 0;
        }

        function extractImages(data) {
            const list = data.data || data.result || data || [];
            return list.map(item => item.image || item.media || item.url || item).filter(u => typeof u === 'string' && u.startsWith('http'));
        }

        function createCard(url) {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `
                <div class="card-inner">
                    <img src="${url}" loading="lazy" alt="Visual">
                    <div class="card-actions">
                        <button class="mini-btn" onclick="event.stopPropagation(); quickFav('${url}')"><i class="${state.favorites.includes(url) ? 'fas' : 'far'} fa-heart"></i></button>
                    </div>
                </div>
            `;
            el.onclick = () => openStudio(url);
            return el;
        }

        // --- STUDIO LOGIC ---
        function openStudio(url) {
            state.currentUrl = url;
            // Use Proxy for CORS to allow canvas editing
            DOM.preview.src = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            
            resetFilters();
            updateFavStatus();
            DOM.studio.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Modified closeStudio to reset zoom state
        function closeStudio() {
            DOM.studio.classList.remove('active');
            // Remove Maximize state when closing so next image opens normally
            document.querySelector('.studio-container').classList.remove('maximize');
            document.body.style.overflow = '';
        }

        // --- üî≠ MAXIMIZE / ZOOM FUNCTION ---
        function toggleMaximize() {
            const container = document.querySelector('.studio-container');
            container.classList.toggle('maximize');
            
            // Optional: Show toast message on first click
            if(container.classList.contains('maximize')){
                showToast("Full View Mode");
            }
        }

        // Filter Handling
        document.querySelectorAll('input[type=range]').forEach(input => {
            input.addEventListener('input', (e) => {
                const type = e.target.dataset.filter;
                state.filters[type] = e.target.value;
                
                // Update UI Label
                const labelMap = { brightness: 'val-b', contrast: 'val-c', saturate: 'val-s', blur: 'val-l' };
                let suffix = type === 'blur' ? 'px' : '%';
                if(document.getElementById(labelMap[type])) {
                    document.getElementById(labelMap[type]).innerText = e.target.value + suffix;
                }
                
                renderFilters();
            });
        });

        function applyPreset(name) {
            // Reset UI Sliders
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const resets = { brightness: 100, contrast: 100, saturate: 100, blur: 0, grayscale: 0, sepia: 0 };
            
            switch(name) {
                case 'noir': Object.assign(resets, { grayscale: 100, contrast: 120, brightness: 90 }); break;
                case 'vintage': Object.assign(resets, { sepia: 50, contrast: 90, saturate: 80 }); break;
                case 'vivid': Object.assign(resets, { saturate: 150, contrast: 110 }); break;
                case 'cyber': Object.assign(resets, { saturate: 130, contrast: 120, brightness: 110 }); break;
            }
            
            state.filters = resets;
            
            // Sync sliders to preset values
            document.querySelectorAll('input[type=range]').forEach(inp => {
                const type = inp.dataset.filter;
                if(state.filters[type] !== undefined) inp.value = state.filters[type];
            });
            
            renderFilters();
        }

        function renderFilters() {
            const f = state.filters;
            DOM.preview.style.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturate}%) blur(${f.blur}px) grayscale(${f.grayscale}%) sepia(${f.sepia}%)`;
        }

        function resetFilters() {
            applyPreset('normal');
        }

        // --- DOWNLOAD SYSTEM ---
        async function downloadImage() {
            const btn = document.getElementById('dl-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Processing...`;

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = DOM.preview;

                // Wait for image load
                if (!img.complete) await new Promise(r => img.onload = r);

                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                // Apply filters to context
                const f = state.filters;
                ctx.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturate}%) blur(${f.blur}px) grayscale(${f.grayscale}%) sepia(${f.sepia}%)`;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Watermark (Optional)
                ctx.font = `bold ${canvas.width * 0.02}px sans-serif`;
                ctx.fillStyle = "rgba(255,255,255,0.5)";
                ctx.fillText("GALLERY AGENCY", canvas.width * 0.02, canvas.height * 0.98);

                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.download = `Gallery_Edit_${Date.now()}.jpg`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    showToast("Saved to Device");
                    btn.innerHTML = originalText;
                }, 'image/jpeg', 0.9);

            } catch (e) {
                console.error(e);
                showToast("Error processing. Opening raw.");
                window.open(state.currentUrl, '_blank');
                btn.innerHTML = originalText;
            }
        }

        // --- FAVORITES SYSTEM ---
        function toggleFavorite() {
            const url = state.currentUrl;
            const index = state.favorites.indexOf(url);
            
            if (index > -1) {
                state.favorites.splice(index, 1);
                showToast("Removed from Favorites");
            } else {
                state.favorites.push(url);
                showToast("Added to Favorites");
            }
            
            localStorage.setItem('gallery_favs', JSON.stringify(state.favorites));
            updateFavStatus();
            if(state.view === 'fav') loadFavorites();
        }

        function quickFav(url) {
            if(!state.favorites.includes(url)) {
                state.favorites.push(url);
                showToast("Added to Favorites");
            } else {
                state.favorites = state.favorites.filter(u => u !== url);
                showToast("Removed");
            }
            localStorage.setItem('gallery_favs', JSON.stringify(state.favorites));
            
            // Refresh grid icons if in view
            if(state.view === 'grid') { /* Complex to update just one icon, skipping for brevity */ }
            if(state.view === 'fav') loadFavorites();
        }

        function updateFavStatus() {
            const btn = document.getElementById('fav-btn');
            const isFav = state.favorites.includes(state.currentUrl);
            btn.innerHTML = isFav 
                ? `<i class="fas fa-heart" style="color:var(--accent-gold)"></i> Saved` 
                : `<i class="far fa-heart"></i> Add to Favorites`;
            btn.style.borderColor = isFav ? 'var(--accent-gold)' : 'var(--border)';
        }

        function loadFavorites() {
            DOM.grid.innerHTML = '';
            if (state.favorites.length === 0) {
                DOM.grid.innerHTML = `<div style="text-align:center; grid-column:span 5; padding:50px;">Your collection is empty.</div>`;
                return;
            }
            state.favorites.forEach(url => DOM.grid.appendChild(createCard(url)));
            // Trigger animations
            setTimeout(() => document.querySelectorAll('.card').forEach(c => c.classList.add('visible')), 100);
        }

        // --- NAVIGATION & UTILS ---
        function switchView(viewName) {
            state.view = viewName;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');

            if (viewName === 'grid') {
                document.getElementById('hero').style.display = 'block';
                fetchContent();
            } else {
                document.getElementById('hero').style.display = 'none';
                loadFavorites();
            }
        }

        function triggerSearch(term) {
            DOM.search.value = term;
            state.query = term;
            
            document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
            // Highlight tag if matches text (simple check)
            
            switchView('grid');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Listeners
        function setupEvents() {
            // Search Input
            DOM.search.addEventListener('keypress', (e) => {
                if(e.key === 'Enter' && e.target.value.trim()) {
                    triggerSearch(e.target.value.trim());
                }
            });

            // Infinite Scroll
            window.addEventListener('scroll', () => {
                const scrolled = window.scrollY + window.innerHeight;
                const threshold = document.body.offsetHeight - 500;
                
                // Hide/Show Header
                if(window.scrollY > 100) DOM.header.classList.add('hide'); 
                else DOM.header.classList.remove('hide');

                if (state.view === 'grid' && scrolled >= threshold && !state.loading) {
                    fetchContent(true);
                }
            });
        }

        async function shareImage() {
            showToast("PREPARING IMAGE...");
            
            try {
                // Fetch image via proxy to handle CORS
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(state.currentUrl);
                const response = await fetch(proxyUrl);
                const blob = await response.blob();
                
                // Create File object
                const file = new File([blob], "gallery_agency_share.jpg", { type: blob.type });

                // Check for Web Share API support with files
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Gallery Agency',
                        text: 'Visual by Gallery Agency'
                    });
                    showToast("IMAGE SHARED");
                } else {
                    throw new Error("File sharing not supported");
                }

            } catch (err) {
                // Fallback: Share link if file sharing fails
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Gallery Agency',
                            text: 'Check out this visual by Gallery Agency',
                            url: state.currentUrl
                        });
                    } catch (e) { console.log('Share canceled'); }
                } else {
                    navigator.clipboard.writeText(state.currentUrl);
                    showToast("LINK COPIED (IMAGE SHARE N/A)");
                }
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fas fa-info-circle" style="color:var(--accent-gold)"></i> <span>${msg}</span>`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function resetApp() {
            location.reload();
        }
    </script>
</body>
</html>
